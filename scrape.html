<html>
    <head>
        <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
        <style>
            pre {
                width: 800px;
                background-color: #eee;
                margin: 20px;
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <h3> sites </h3>
        <pre class="sites todo"></pre>
        <pre class="sites done"></pre>
        <h3> pages </h3>
        <pre class="pages todo"></pre>
        <pre class="pages done"></pre>
        <script>

        function main() {

            var sites_todo = ['journal.hapgood.net'],
                sites_done = [];

            var pages_todo = [],
                pages_done = [];

            var oldest = Date.now() - 1000*60*60*24*30

            function show(id,list) {
                $(id).text(list.slice().reverse().join("\n"));
                return list;
            }

            function report() {
                show('.sites.todo',sites_todo);
                show('.sites.done',sites_done);
                show('.pages.todo',pages_todo);
                show('.pages.done',pages_done);
            }

            function new_site (site) {
                return sites_done.indexOf(site) < 0 &&
                       sites_todo.indexOf(site) < 0
            }

            function new_page (site_page) {
                return pages_done.indexOf(site_page) < 0 &&
                       pages_todo.indexOf(site_page) < 0
            }

            function remove (array, element) {
                var index = array.indexOf(element);
                if (index > -1) {
                    array.splice(index, 1);
                }
                return element
            }

            function do_site(site, sitemap) {
                for (var i=0; i<sitemap.length; i++) {
                    try {
                        var entry = sitemap[i];
                        // {date, slug, title, synopsis}
                        if (entry.date > oldest) {
                            var site_page = site + '/' + entry.slug
                            if (new_page(site_page)) {
                                pages_todo.push(site_page)
                            }
                            report();
                        }
                    }
                    catch (e) {
                    }
                }
            }

            function do_page(site, slug, page) {
                // {title, story, journal}
                 try {
                    for (var i=0; i<page.story.length; i++) {
                        var item = page.story[i]
                        // {type:'paragraph', text}
                        // {type:'image', text, url}
                        // {type:'reference', text, site, slug}
                        if (item.site && new_site(item.site)) {
                            sites_todo.push(item.site)
                        }
                    }
                    for (var i=0; i<page.journal.length; i++) {
                        var action = page.journal[i]
                        // {type, date}
                        // {type:'fork', date, site}
                        if (action.site && new_site(action.site)) {
                            sites_todo.push(action.site)
                        }
                    }                    
                }
                catch (e) {              
                }

            }

            function fetch_site(site) {
                sites_done.push(site); report()
                var url = 'http://' + site + '/system/sitemap.json';
                $.getJSON(url, function(sitemap) {
                    do_site(site, sitemap)
                })                   
            }

            function fetch_page(site_page) {
                pages_done.push(site_page); report()
                var detail = site_page.split('/'),
                    url = 'http://' + detail[0] + '/' + detail[1] + '.json'
                $.getJSON(url, function(page) {
                    do_page(detail[0], detail[1], page)
                })
            }

            function next () {
                if (sites_todo.length) {
                    fetch_site(sites_todo.shift())
                }
                if (pages_todo.length) {
                    fetch_page(pages_todo.shift())
                }
            }

            setInterval(next, 200)

        }

        main();

        </script>
    </body>
</html>